# T10.1.35 – Bugfix: Heater PWM bei geschlossener Tür

## Kontext
Projekt: **ESP32-S3 UI Fortsetzung T10**  
Bug-ID: **T10.1.35**  
Betroffene Komponente: **Client (ESP32-WROOM)**  
Signal: **HEATER (GPIO12 / P6)**  
PWM: **4 kHz**

---

## Beschreibung des Problems

Beim Einschalten des HEATER über die UI (Host → Client) wurde **kein stabiles PWM-Signal**
am Ausgang **GPIO12 (P6)** beobachtet.

**Symptome:**
- Oszilloskop zeigt nur eine kurze Flanke (LOW → HIGH → LOW)
- Kein dauerhaftes 4-kHz-PWM-Signal
- Client-Log meldet zwar:
  ```
  [HEATER] g_heaterPwmRunning now running. GPIO: 12, Freq: 4000Hz
  ```
  aber beim Abschalten folgt:
  ```
  ledcDetach(): pin 12 is not attached to LEDC
  ```

---

## Analyse des Problems

Die Ursache lag **nicht in der UI, nicht im Host und nicht im Protokoll**, sondern
ausschließlich in der **Client-seitigen PWM-Initialisierung**:

### Kernproblem
- `ledcAttach(GPIO12, ...)` **liefert einen booleschen Rückgabewert**
- Dieser Rückgabewert wurde **nicht ausgewertet**
- `g_heaterPwmRunning` wurde **immer auf `true` gesetzt**, auch wenn:
  - der Attach fehlgeschlagen ist
  - der Pin real nie mit dem LEDC-Timer verbunden war

### Konsequenzen
- PWM lief logisch, aber **nicht physikalisch**
- Beim Abschalten wurde `ledcDetach()` aufgerufen, obwohl:
  - der Pin nie attached war → Fehlermeldung
- Am Oszilloskop erschien nur ein kurzer Glitch

### Wichtige Erkenntnis
Der 220-Ohm-Widerstand zwischen GPIO12 und P6 war **nicht die Ursache**  
(Verifikation durch Durchgangsprüfung & Vergleich mit FAN12V).

---

## Fix

### Prinzip
- PWM-State darf **nur dann aktiv sein**, wenn `ledcAttach()` erfolgreich war
- Fail-safe: bei Attach-Fehler Pin auf sicheren Ausgangszustand setzen
- `ledcDetach()` nur ausführen, wenn PWM tatsächlich lief

### Geänderte Datei
```
src/client/Client.cpp
```

### Betroffene Funktion
```cpp
static void heaterPwmEnable(bool enable)
```

### Fix-Details
- Rückgabewert von `ledcAttach()` prüfen
- `g_heaterPwmRunning = true` **nur bei Erfolg**
- Bei Fehler:
  - PWM nicht starten
  - GPIO explizit auf `HEATER_SAFE_LEVEL`
- `ledcDetach()` nur wenn `g_heaterPwmRunning == true`

---

## Verifikation

### Messung
- **Rigol Oszilloskop**:
  - Frequenz: **3.97 kHz**
  - Periodendauer: **~252 µs**
- **OWON HDS242S**:
  - Frequenz: **4.0 kHz**
  - Periodendauer: **~250 µs**

### Ergebnis
✅ Stabiles PWM-Signal  
✅ Kein Glitch  
✅ Kein `ledcDetach()`-Fehler  
✅ Verhalten konsistent mit UI / Host / Status-Mask

---

## Status
**T10.1.35: CLOSED / OK**

Nächster Schritt:
➡️ **T10.1.36 – Safety-Workflow (Door → Motor / Heater Interlock)**  
